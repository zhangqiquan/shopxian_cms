<?php 

           /**
            * 秀仙系统 shopxian_release/3.0.0
            * ============================================================================
            * * 版权所有 2017-2018 上海秀仙网络科技有限公司，并保留所有权利。
            * 网站地址: http://www.shopxian.com；
            * ----------------------------------------------------------------------------
            * 本软件只能免费使用  不允许对程序代码以任何形式任何目的再发布或者出售。
            * ============================================================================
            * 作者: 张启全 

            * 时间: 2018-03-11 18:25:12
            */
         namespace lib\base;    class ipLocation {            private $fp;              private $firstip;              private $lastip;              private $totalip;              public function __construct($filename = "./UTFWry.dat") {          $this->fp = 0;          if (($this->fp      = fopen(dirname(__FILE__).'/'.$filename, 'rb')) !== false) {              $this->firstip  = $this->getlong();              $this->lastip   = $this->getlong();              $this->totalip  = ($this->lastip - $this->firstip) / 7;          }      }              private function getlong() {                   $result = unpack('Vlong', fread($this->fp, 4));          return $result['long'];      }              private function getlong3() {                   $result = unpack('Vlong', fread($this->fp, 3).chr(0));          return $result['long'];      }              private function packip($ip) {                            return pack('N', intval(ip2long($ip)));      }              private function getstring($data = "") {          $char = fread($this->fp, 1);          while (ord($char) > 0) {                     $data  .= $char;                          $char   = fread($this->fp, 1);          }          return $data;      }              private function getarea() {          $byte = fread($this->fp, 1);             switch (ord($byte)) {              case 0:                                      $area = "";                  break;              case 1:              case 2:                                      fseek($this->fp, $this->getlong3());                  $area = $this->getstring();                  break;              default:                                     $area = $this->getstring($byte);                  break;          }          return $area;      }            public function getlocation($ip='') {          if (!$this->fp) return null;                     if(empty($ip)) $ip = getip();          $location['ip'] = gethostbyname($ip);            $ip = $this->packip($location['ip']);                                                                      $l = 0;                                  $u = $this->totalip;                     $findip = $this->lastip;                 while ($l <= $u) {                           $i = floor(($l + $u) / 2);               fseek($this->fp, $this->firstip + $i * 7);              $beginip = strrev(fread($this->fp, 4));                                            if ($ip < $beginip) {                        $u = $i - 1;                         }              else {                  fseek($this->fp, $this->getlong3());                  $endip = strrev(fread($this->fp, 4));                    if ($ip > $endip) {                          $l = $i + 1;                         }                  else {                                       $findip = $this->firstip + $i * 7;                      break;                               }              }          }                     fseek($this->fp, $findip);          $location['beginip'] = long2ip($this->getlong());            $offset = $this->getlong3();          fseek($this->fp, $offset);          $location['endip'] = long2ip($this->getlong());              $byte = fread($this->fp, 1);             switch (ord($byte)) {              case 1:                                      $countryOffset = $this->getlong3();                          fseek($this->fp, $countryOffset);                  $byte = fread($this->fp, 1);                     switch (ord($byte)) {                      case 2:                                      fseek($this->fp, $this->getlong3());                          $location['country']    = $this->getstring();                          fseek($this->fp, $countryOffset + 4);                          $location['area']       = $this->getarea();                          break;                      default:                                     $location['country']    = $this->getstring($byte);                          $location['area']       = $this->getarea();                          break;                  }                  break;              case 2:                                      fseek($this->fp, $this->getlong3());                  $location['country']    = $this->getstring();                  fseek($this->fp, $offset + 8);                  $location['area']       = $this->getarea();                  break;              default:                                     $location['country']    = $this->getstring($byte);                  $location['area']       = $this->getarea();                  break;          }          if (trim($location['country']) == 'CZ88.NET') {               $location['country'] = '未知';          }          if (trim($location['area']) == 'CZ88.NET') {              $location['area'] = '';          }          return $location;      }              public function __destruct() {          if ($this->fp) {              fclose($this->fp);          }          $this->fp = 0;      }    }  