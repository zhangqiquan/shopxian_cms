<?php 
      class PHPExcel_Shared_String  {                       const STRING_REGEXP_FRACTION    = '(-?)(\d+)\s+(\d+\/\d+)';                private static $controlCharacters = array();              private static $SYLKCharacters = array();              private static $decimalSeparator;              private static $thousandsSeparator;              private static $currencyCode;              private static $isMbstringEnabled;              private static $isIconvEnabled;              private static function buildControlCharacters()      {          for ($i = 0; $i <= 31; ++$i) {              if ($i != 9 && $i != 10 && $i != 13) {                  $find = '_x' . sprintf('%04s', strtoupper(dechex($i))) . '_';                  $replace = chr($i);                  self::$controlCharacters[$find] = $replace;              }          }      }              private static function buildSYLKCharacters()      {          self::$SYLKCharacters = array(              "\x1B 0"  => chr(0),              "\x1B 1"  => chr(1),              "\x1B 2"  => chr(2),              "\x1B 3"  => chr(3),              "\x1B 4"  => chr(4),              "\x1B 5"  => chr(5),              "\x1B 6"  => chr(6),              "\x1B 7"  => chr(7),              "\x1B 8"  => chr(8),              "\x1B 9"  => chr(9),              "\x1B :"  => chr(10),              "\x1B ;"  => chr(11),              "\x1B <"  => chr(12),              "\x1B :"  => chr(13),              "\x1B >"  => chr(14),              "\x1B ?"  => chr(15),              "\x1B!0"  => chr(16),              "\x1B!1"  => chr(17),              "\x1B!2"  => chr(18),              "\x1B!3"  => chr(19),              "\x1B!4"  => chr(20),              "\x1B!5"  => chr(21),              "\x1B!6"  => chr(22),              "\x1B!7"  => chr(23),              "\x1B!8"  => chr(24),              "\x1B!9"  => chr(25),              "\x1B!:"  => chr(26),              "\x1B!;"  => chr(27),              "\x1B!<"  => chr(28),              "\x1B!="  => chr(29),              "\x1B!>"  => chr(30),              "\x1B!?"  => chr(31),              "\x1B'?"  => chr(127),              "\x1B(0"  => 'â‚¬',              "\x1B(2"  => 'â€š',              "\x1B(3"  => 'Æ’',              "\x1B(4"  => 'â€ž',              "\x1B(5"  => 'â€¦',              "\x1B(6"  => 'â€ ',              "\x1B(7"  => 'â€¡',              "\x1B(8"  => 'Ë†',              "\x1B(9"  => 'â€°',              "\x1B(:"  => 'Å ',              "\x1B(;"  => 'â€¹',              "\x1BNj"  => 'Å’',              "\x1B(>"  => 'Å½',              "\x1B)1"  => 'â€˜',              "\x1B)2"  => 'â€™',              "\x1B)3"  => 'â€œ',              "\x1B)4"  => 'â€',              "\x1B)5"  => 'â€¢',              "\x1B)6"  => 'â€“',              "\x1B)7"  => 'â€”',              "\x1B)8"  => 'Ëœ',              "\x1B)9"  => 'â„¢',              "\x1B):"  => 'Å¡',              "\x1B);"  => 'â€º',              "\x1BNz"  => 'Å“',              "\x1B)>"  => 'Å¾',              "\x1B)?"  => 'Å¸',              "\x1B*0"  => 'Â ',              "\x1BN!"  => 'Â¡',              "\x1BN\"" => 'Â¢',              "\x1BN#"  => 'Â£',              "\x1BN("  => 'Â¤',              "\x1BN%"  => 'Â¥',              "\x1B*6"  => 'Â¦',              "\x1BN'"  => 'Â§',              "\x1BNH " => 'Â¨',              "\x1BNS"  => 'Â©',              "\x1BNc"  => 'Âª',              "\x1BN+"  => 'Â«',              "\x1B*<"  => 'Â¬',              "\x1B*="  => 'Â­',              "\x1BNR"  => 'Â®',              "\x1B*?"  => 'Â¯',              "\x1BN0"  => 'Â°',              "\x1BN1"  => 'Â±',              "\x1BN2"  => 'Â²',              "\x1BN3"  => 'Â³',              "\x1BNB " => 'Â´',              "\x1BN5"  => 'Âµ',              "\x1BN6"  => 'Â¶',              "\x1BN7"  => 'Â·',              "\x1B+8"  => 'Â¸',              "\x1BNQ"  => 'Â¹',              "\x1BNk"  => 'Âº',              "\x1BN;"  => 'Â»',              "\x1BN<"  => 'Â¼',              "\x1BN="  => 'Â½',              "\x1BN>"  => 'Â¾',              "\x1BN?"  => 'Â¿',              "\x1BNAA" => 'Ã€',              "\x1BNBA" => 'Ã',              "\x1BNCA" => 'Ã‚',              "\x1BNDA" => 'Ãƒ',              "\x1BNHA" => 'Ã„',              "\x1BNJA" => 'Ã…',              "\x1BNa"  => 'Ã†',              "\x1BNKC" => 'Ã‡',              "\x1BNAE" => 'Ãˆ',              "\x1BNBE" => 'Ã‰',              "\x1BNCE" => 'ÃŠ',              "\x1BNHE" => 'Ã‹',              "\x1BNAI" => 'ÃŒ',              "\x1BNBI" => 'Ã',              "\x1BNCI" => 'ÃŽ',              "\x1BNHI" => 'Ã',              "\x1BNb"  => 'Ã',              "\x1BNDN" => 'Ã‘',              "\x1BNAO" => 'Ã’',              "\x1BNBO" => 'Ã“',              "\x1BNCO" => 'Ã”',              "\x1BNDO" => 'Ã•',              "\x1BNHO" => 'Ã–',              "\x1B-7"  => 'Ã—',              "\x1BNi"  => 'Ã˜',              "\x1BNAU" => 'Ã™',              "\x1BNBU" => 'Ãš',              "\x1BNCU" => 'Ã›',              "\x1BNHU" => 'Ãœ',              "\x1B-="  => 'Ã',              "\x1BNl"  => 'Ãž',              "\x1BN{"  => 'ÃŸ',              "\x1BNAa" => 'Ã ',              "\x1BNBa" => 'Ã¡',              "\x1BNCa" => 'Ã¢',              "\x1BNDa" => 'Ã£',              "\x1BNHa" => 'Ã¤',              "\x1BNJa" => 'Ã¥',              "\x1BNq"  => 'Ã¦',              "\x1BNKc" => 'Ã§',              "\x1BNAe" => 'Ã¨',              "\x1BNBe" => 'Ã©',              "\x1BNCe" => 'Ãª',              "\x1BNHe" => 'Ã«',              "\x1BNAi" => 'Ã¬',              "\x1BNBi" => 'Ã­',              "\x1BNCi" => 'Ã®',              "\x1BNHi" => 'Ã¯',              "\x1BNs"  => 'Ã°',              "\x1BNDn" => 'Ã±',              "\x1BNAo" => 'Ã²',              "\x1BNBo" => 'Ã³',              "\x1BNCo" => 'Ã´',              "\x1BNDo" => 'Ãµ',              "\x1BNHo" => 'Ã¶',              "\x1B/7"  => 'Ã·',              "\x1BNy"  => 'Ã¸',              "\x1BNAu" => 'Ã¹',              "\x1BNBu" => 'Ãº',              "\x1BNCu" => 'Ã»',              "\x1BNHu" => 'Ã¼',              "\x1B/="  => 'Ã½',              "\x1BN|"  => 'Ã¾',              "\x1BNHy" => 'Ã¿',          );      }              public static function getIsMbstringEnabled()      {          if (isset(self::$isMbstringEnabled)) {              return self::$isMbstringEnabled;          }            self::$isMbstringEnabled = function_exists('mb_convert_encoding') ?              true : false;            return self::$isMbstringEnabled;      }              public static function getIsIconvEnabled()      {          if (isset(self::$isIconvEnabled)) {              return self::$isIconvEnabled;          }                     if (!function_exists('iconv')) {              self::$isIconvEnabled = false;              return false;          }                     if (!@iconv('UTF-8', 'UTF-16LE', 'x')) {              self::$isIconvEnabled = false;              return false;          }                              if (!@iconv_substr('A', 0, 1, 'UTF-8')) {              self::$isIconvEnabled = false;              return false;          }                     if (defined('PHP_OS') && @stristr(PHP_OS, 'AIX') && defined('ICONV_IMPL') && (@strcasecmp(ICONV_IMPL, 'unknown') == 0) && defined('ICONV_VERSION') && (@strcasecmp(ICONV_VERSION, 'unknown') == 0)) {              self::$isIconvEnabled = false;              return false;          }                     self::$isIconvEnabled = true;          return true;      }        public static function buildCharacterSets()      {          if (empty(self::$controlCharacters)) {              self::buildControlCharacters();          }          if (empty(self::$SYLKCharacters)) {              self::buildSYLKCharacters();          }      }              public static function ControlCharacterOOXML2PHP($value = '')      {          return str_replace(array_keys(self::$controlCharacters), array_values(self::$controlCharacters), $value);      }              public static function ControlCharacterPHP2OOXML($value = '')      {          return str_replace(array_values(self::$controlCharacters), array_keys(self::$controlCharacters), $value);      }              public static function SanitizeUTF8($value)      {          if (self::getIsIconvEnabled()) {              $value = @iconv('UTF-8', 'UTF-8', $value);              return $value;          }            if (self::getIsMbstringEnabled()) {              $value = mb_convert_encoding($value, 'UTF-8', 'UTF-8');              return $value;          }                     return $value;      }              public static function IsUTF8($value = '')      {          return $value === '' || preg_match('/^./su', $value) === 1;      }              public static function FormatNumber($value)      {          if (is_float($value)) {              return str_replace(',', '.', $value);          }          return (string) $value;      }              public static function UTF8toBIFF8UnicodeShort($value, $arrcRuns = array())      {                   $ln = self::CountCharacters($value, 'UTF-8');                   if (empty($arrcRuns)) {              $opt = (self::getIsIconvEnabled() || self::getIsMbstringEnabled()) ?                  0x0001 : 0x0000;              $data = pack('CC', $ln, $opt);                           $data .= self::ConvertEncoding($value, 'UTF-16LE', 'UTF-8');          } else {              $data = pack('vC', $ln, 0x09);              $data .= pack('v', count($arrcRuns));                           $data .= self::ConvertEncoding($value, 'UTF-16LE', 'UTF-8');              foreach ($arrcRuns as $cRun) {                  $data .= pack('v', $cRun['strlen']);                  $data .= pack('v', $cRun['fontidx']);              }          }          return $data;      }              public static function UTF8toBIFF8UnicodeLong($value)      {                   $ln = self::CountCharacters($value, 'UTF-8');                     $opt = (self::getIsIconvEnabled() || self::getIsMbstringEnabled()) ?              0x0001 : 0x0000;                     $chars = self::ConvertEncoding($value, 'UTF-16LE', 'UTF-8');            $data = pack('vC', $ln, $opt) . $chars;          return $data;      }              public static function ConvertEncoding($value, $to, $from)      {          if (self::getIsIconvEnabled()) {              return iconv($from, $to, $value);          }            if (self::getIsMbstringEnabled()) {              return mb_convert_encoding($value, $to, $from);          }            if ($from == 'UTF-16LE') {              return self::utf16_decode($value, false);          } elseif ($from == 'UTF-16BE') {              return self::utf16_decode($value);          }                   return $value;      }              public static function utf16_decode($str, $bom_be = true)      {          if (strlen($str) < 2) {              return $str;          }          $c0 = ord($str{0});          $c1 = ord($str{1});          if ($c0 == 0xfe && $c1 == 0xff) {              $str = substr($str, 2);          } elseif ($c0 == 0xff && $c1 == 0xfe) {              $str = substr($str, 2);              $bom_be = false;          }          $len = strlen($str);          $newstr = '';          for ($i=0; $i<$len; $i+=2) {              if ($bom_be) {                  $val = ord($str{$i})   << 4;                  $val += ord($str{$i+1});              } else {                  $val = ord($str{$i+1}) << 4;                  $val += ord($str{$i});              }              $newstr .= ($val == 0x228) ? "\n" : chr($val);          }          return $newstr;      }              public static function CountCharacters($value, $enc = 'UTF-8')      {          if (self::getIsMbstringEnabled()) {              return mb_strlen($value, $enc);          }            if (self::getIsIconvEnabled()) {              return iconv_strlen($value, $enc);          }                     return strlen($value);      }              public static function Substring($pValue = '', $pStart = 0, $pLength = 0)      {          if (self::getIsMbstringEnabled()) {              return mb_substr($pValue, $pStart, $pLength, 'UTF-8');          }            if (self::getIsIconvEnabled()) {              return iconv_substr($pValue, $pStart, $pLength, 'UTF-8');          }                     return substr($pValue, $pStart, $pLength);      }              public static function StrToUpper($pValue = '')      {          if (function_exists('mb_convert_case')) {              return mb_convert_case($pValue, MB_CASE_UPPER, "UTF-8");          }          return strtoupper($pValue);      }              public static function StrToLower($pValue = '')      {          if (function_exists('mb_convert_case')) {              return mb_convert_case($pValue, MB_CASE_LOWER, "UTF-8");          }          return strtolower($pValue);      }              public static function StrToTitle($pValue = '')      {          if (function_exists('mb_convert_case')) {              return mb_convert_case($pValue, MB_CASE_TITLE, "UTF-8");          }          return ucwords($pValue);      }        public static function mb_is_upper($char)      {          return mb_strtolower($char, "UTF-8") != $char;      }        public static function mb_str_split($string)      {          # Split at all position not after the start: ^          # and not before the end: $          return preg_split('/(?<!^)(?!$)/u', $string);      }              public static function StrCaseReverse($pValue = '')      {          if (self::getIsMbstringEnabled()) {              $characters = self::mb_str_split($pValue);              foreach ($characters as &$character) {                  if (self::mb_is_upper($character)) {                      $character = mb_strtolower($character, 'UTF-8');                  } else {                      $character = mb_strtoupper($character, 'UTF-8');                  }              }              return implode('', $characters);          }          return strtolower($pValue) ^ strtoupper($pValue) ^ $pValue;      }              public static function convertToNumberIfFraction(&$operand)      {          if (preg_match('/^'.self::STRING_REGEXP_FRACTION.'$/i', $operand, $match)) {              $sign = ($match[1] == '-') ? '-' : '+';              $fractionFormula = '='.$sign.$match[2].$sign.$match[3];              $operand = PHPExcel_Calculation::getInstance()->_calculateFormulaValue($fractionFormula);              return true;          }          return false;      }                 public static function getDecimalSeparator()      {          if (!isset(self::$decimalSeparator)) {              $localeconv = localeconv();              self::$decimalSeparator = ($localeconv['decimal_point'] != '')                  ? $localeconv['decimal_point'] : $localeconv['mon_decimal_point'];                if (self::$decimalSeparator == '') {                                   self::$decimalSeparator = '.';              }          }          return self::$decimalSeparator;      }              public static function setDecimalSeparator($pValue = '.')      {          self::$decimalSeparator = $pValue;      }              public static function getThousandsSeparator()      {          if (!isset(self::$thousandsSeparator)) {              $localeconv = localeconv();              self::$thousandsSeparator = ($localeconv['thousands_sep'] != '')                  ? $localeconv['thousands_sep'] : $localeconv['mon_thousands_sep'];                if (self::$thousandsSeparator == '') {                                   self::$thousandsSeparator = ',';              }          }          return self::$thousandsSeparator;      }              public static function setThousandsSeparator($pValue = ',')      {          self::$thousandsSeparator = $pValue;      }              public static function getCurrencyCode()      {          if (!isset(self::$currencyCode)) {              $localeconv = localeconv();              self::$currencyCode = ($localeconv['currency_symbol'] != '')                  ? $localeconv['currency_symbol'] : $localeconv['int_curr_symbol'];                if (self::$currencyCode == '') {                                   self::$currencyCode = '$';              }          }          return self::$currencyCode;      }              public static function setCurrencyCode($pValue = '$')      {          self::$currencyCode = $pValue;      }              public static function SYLKtoUTF8($pValue = '')      {                   if (strpos($pValue, '') === false) {              return $pValue;          }            foreach (self::$SYLKCharacters as $k => $v) {              $pValue = str_replace($k, $v, $pValue);          }            return $pValue;      }              public static function testStringAsNumeric($value)      {          if (is_numeric($value)) {              return $value;          }          $v = floatval($value);          return (is_numeric(substr($value, 0, strlen($v)))) ? $v : $value;      }  }  